<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matt Slade - Knowledge Base Search</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .highlight {
            background-color: #ffffcc;
            padding: 0 2px;
        }
        .result-card {
            transition: transform 0.2s;
        }
        .result-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .document-icon {
            font-size: 2rem;
            margin-right: 1rem;
        }
        .property-row {
            display: flex;
            margin-bottom: 0.5rem;
        }
        .property-label {
            font-weight: 600;
            width: 120px;
            color: #4B5563;
        }
        .property-value {
            flex: 1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-blue-800">Knowledge Base Search</h1>
            <p class="text-lg text-gray-600 mt-2">NetStar Inc. - Vendor & Technology Information</p>
        </header>

        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex flex-col md:flex-row gap-2">
                <input type="text" id="searchInput" placeholder="Ask a question or search by keyword..." 
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="searchButton" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md">
                    Search
                </button>
            </div>
            <div class="mt-2 text-sm text-gray-500">
                Try asking: "What integrations does GoTo provide?" or "Which vendors offer cloud services?"
            </div>
        </div>

        <div id="resultsContainer" class="max-w-4xl mx-auto">
            <!-- Search results will appear here -->
            <div id="initialMessage" class="text-center text-gray-500 py-8">
                Enter a search term or ask a question to find information from your knowledge base
            </div>
            <div id="directAnswer" class="mb-6 hidden"></div>
            <div id="searchResults" class="space-y-4"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const searchResults = document.getElementById('searchResults');
            const directAnswer = document.getElementById('directAnswer');
            const initialMessage = document.getElementById('initialMessage');
            let knowledgeBase = null;

            // Keywords to extract from natural language questions
            const keywordMap = {
                'integration': ['integration', 'connect', 'connection', 'connects', 'integrates', 'api'],
                'security': ['security', 'secure', 'protection', 'protect', 'safe'],
                'cloud': ['cloud', 'hosted', 'saas', 'online'],
                'voip': ['voip', 'phone', 'telephony', 'call', 'voice'],
                'vendor': ['vendor', 'provider', 'company', 'partner'],
                'microsoft': ['microsoft', 'ms', 'azure', '365', 'office'],
                'aws': ['aws', 'amazon'],
                'cisco': ['cisco', 'webex'],
                'goto': ['goto', 'logmein'],
                'nextive': ['nextive', 'nexitive'],
                'network': ['network', 'routing', 'switch', 'infrastructure']
            };

            // Document type icons
            const documentIcons = {
                'docx': 'fas fa-file-word text-blue-500',
                'xlsx': 'fas fa-file-excel text-green-500',
                'pptx': 'fas fa-file-powerpoint text-red-500',
                'pdf': 'fas fa-file-pdf text-red-700',
                'md': 'fas fa-file-alt text-gray-700',
                'json': 'fas fa-file-code text-yellow-600',
                'default': 'fas fa-file text-gray-500'
            };

            // Fetch the knowledge base
            fetch('https://raw.githubusercontent.com/Sladed49er/email-ai-knowledge-base/main/knowledge-base.json')
                .then(response => response.json())
                .then(data => {
                    knowledgeBase = data;
                    console.log('Knowledge base loaded:', knowledgeBase);
                    
                    // Auto-search if there's a query parameter
                    const urlParams = new URLSearchParams(window.location.search);
                    const query = urlParams.get('q');
                    if (query) {
                        searchInput.value = query;
                        performSearch();
                    }
                })
                .catch(error => {
                    console.error('Error loading knowledge base:', error);
                    searchResults.innerHTML = `
                        <div class="bg-red-100 text-red-700 p-4 rounded-md">
                            <p class="font-medium">Error loading knowledge base</p>
                            <p>Please check your internet connection or repository URL.</p>
                        </div>
                    `;
                });

            // Process natural language questions to extract keywords
            function extractKeywords(question) {
                question = question.toLowerCase();
                let extractedKeywords = [];
                
                // Check for vendor names first (most specific)
                Object.entries(knowledgeBase || {}).forEach(([category, items]) => {
                    if (category === 'vendors' && Array.isArray(items)) {
                        items.forEach(vendor => {
                            if (vendor.name && question.includes(vendor.name.toLowerCase())) {
                                extractedKeywords.push(vendor.name.toLowerCase());
                            }
                        });
                    }
                });
                
                // Then check for other keyword matches
                Object.entries(keywordMap).forEach(([category, keywords]) => {
                    keywords.forEach(keyword => {
                        if (question.includes(keyword)) {
                            extractedKeywords.push(category);
                        }
                    });
                });
                
                // If it's a question about what something does/provides
                if (question.includes('what') && 
                   (question.includes('do') || question.includes('does') || 
                    question.includes('provide') || question.includes('offer'))) {
                    
                    // Already added vendor names above
                    extractedKeywords.push('integration');
                }
                
                // If it's asking about "which vendors"
                if (question.includes('which') && question.includes('vendor')) {
                    extractedKeywords.push('vendor');
                }
                
                // Remove duplicates
                extractedKeywords = [...new Set(extractedKeywords)];
                
                // If no keywords found, use individual words from the question
                // (but filter out common stop words)
                if (extractedKeywords.length === 0) {
                    const stopWords = ['what', 'which', 'how', 'is', 'are', 'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'with', 'by', 'about', 'like', 'through', 'over', 'before', 'after', 'between', 'under', 'during', 'without', 'of', 'does', 'do', 'did'];
                    const words = question.split(/\s+/);
                    words.forEach(word => {
                        if (!stopWords.includes(word) && word.length > 2) {
                            extractedKeywords.push(word);
                        }
                    });
                }
                
                return extractedKeywords.length > 0 ? extractedKeywords : [question];
            }

            // Search function
            function performSearch() {
                const searchInput = document.getElementById('searchInput').value.trim();
                
                if (!searchInput) {
                    initialMessage.style.display = 'block';
                    directAnswer.classList.add('hidden');
                    searchResults.innerHTML = '';
                    return;
                }

                if (!knowledgeBase) {
                    searchResults.innerHTML = `
                        <div class="bg-yellow-100 text-yellow-700 p-4 rounded-md">
                            <p>Knowledge base is still loading. Please try again in a moment.</p>
                        </div>
                    `;
                    return;
                }

                initialMessage.style.display = 'none';
                directAnswer.classList.add('hidden');
                directAnswer.innerHTML = '';
                searchResults.innerHTML = '';
                
                // Update URL with the search query
                window.history.replaceState({}, '', `?q=${encodeURIComponent(searchInput)}`);
                
                // Extract keywords from the question/search
                const keywords = extractKeywords(searchInput);
                console.log('Extracted keywords:', keywords);
                
                let resultsFound = false;
                
                // For queries that look like questions about integrations
                if (isIntegrationQuestion(searchInput)) {
                    // Try to generate a direct answer about integrations
                    const vendorName = findVendorInQuestion(searchInput);
                    if (vendorName) {
                        const integrationInfo = findVendorIntegrations(vendorName);
                        if (integrationInfo) {
                            displayIntegrationAnswer(integrationInfo, searchInput);
                            resultsFound = true;
                        }
                    }
                }

                // Also show matching results from knowledge base
                const allResults = [];
                
                keywords.forEach(keyword => {
                    const matches = searchKnowledgeBase(keyword.toLowerCase());
                    matches.forEach(match => {
                        // Avoid duplicates in results
                        const isDuplicate = allResults.some(r => 
                            r.category === match.category && 
                            JSON.stringify(r.item) === JSON.stringify(match.item)
                        );
                        
                        if (!isDuplicate) {
                            allResults.push(match);
                            resultsFound = true;
                        }
                    });
                });
                
                // Display all unique results
                allResults.forEach(match => {
                    displayResult(match.item, match.category, searchInput);
                });

                if (!resultsFound) {
                    searchResults.innerHTML = `
                        <div class="bg-gray-100 p-4 rounded-md text-center">
                            <p class="text-gray-700">No results found for "${searchInput}"</p>
                            <p class="text-gray-500 text-sm mt-1">Try a different search term or check spelling</p>
                        </div>
                    `;
                }
            }
            
            // Check if input is asking about integrations
            function isIntegrationQuestion(input) {
                input = input.toLowerCase();
                return (input.includes('integration') || input.includes('connect')) && 
                       (input.includes('what') || input.includes('which') || input.includes('how'));
            }
            
            // Find vendor name in a question
            function findVendorInQuestion(question) {
                question = question.toLowerCase();
                
                // Try to match vendor names from the knowledge base
                if (knowledgeBase && knowledgeBase.vendors) {
                    for (const vendor of knowledgeBase.vendors) {
                        if (vendor.name && question.includes(vendor.name.toLowerCase())) {
                            return vendor.name;
                        }
                    }
                }
                
                // Check for specific vendor keywords from our mapping
                for (const [vendorKey, keywords] of Object.entries(keywordMap)) {
                    if (['microsoft', 'aws', 'cisco', 'goto', 'nextive'].includes(vendorKey)) {
                        for (const keyword of keywords) {
                            if (question.includes(keyword)) {
                                return vendorKey.charAt(0).toUpperCase() + vendorKey.slice(1);
                            }
                        }
                    }
                }
                
                return null;
            }
            
            // Find integration information for a vendor
            function findVendorIntegrations(vendorName) {
                if (!knowledgeBase || !knowledgeBase.vendors) return null;
                
                const normalizedVendorName = vendorName.toLowerCase();
                
                // Search for the vendor in the knowledge base
                for (const vendor of knowledgeBase.vendors) {
                    if (vendor.name && vendor.name.toLowerCase() === normalizedVendorName) {
                        // If vendor has integrations property, use that
                        if (vendor.integrations) {
                            return {
                                vendorName: vendor.name,
                                integrations: vendor.integrations,
                                description: vendor.description || ''
                            };
                        }
                    }
                }
                
                // Look for document references about this vendor's integrations
                const integrationDocs = [];
                if (knowledgeBase.documents) {
                    for (const doc of knowledgeBase.documents) {
                        const docContent = JSON.stringify(doc).toLowerCase();
                        if (docContent.includes(normalizedVendorName) && 
                            (docContent.includes('integration') || docContent.includes('connect'))) {
                            integrationDocs.push(doc);
                        }
                    }
                }
                
                if (integrationDocs.length > 0) {
                    return {
                        vendorName: vendorName,
                        integrationDocs: integrationDocs,
                        description: ''
                    };
                }
                
                // Fallback for specific vendors with hardcoded data
                // This would be used when the knowledge base doesn't contain the information
                if (normalizedVendorName === 'goto') {
                    return {
                        vendorName: 'GoTo',
                        integrations: ['Applied Epic', 'Vertafore AMS360', 'QQ Catalyst'],
                        description: 'GoTo offers cloud-based communication solutions.'
                    };
                }
                else if (normalizedVendorName === 'nextive') {
                    return {
                        vendorName: 'Nextive',
                        description: 'Nextive offers integration solutions for various business systems.',
                        integrationDocs: [{
                            name: 'Vendor_Integration_Map.docx',
                            type: 'docx',
                            description: 'Contains detailed integration information about Nextive.'
                        }]
                    };
                }
                
                return null;
            }
            
            // Display integration answer
            function displayIntegrationAnswer(info, question) {
                directAnswer.classList.remove('hidden');
                directAnswer.innerHTML = '';
                
                const answerCard = document.createElement('div');
                answerCard.className = 'bg-blue-50 p-5 rounded-lg shadow-md border-l-4 border-blue-500';
                
                let contentHTML = `
                    <h3 class="text-xl font-semibold text-blue-700 mb-2">${info.vendorName} Integrations</h3>
                `;
                
                if (info.description) {
                    contentHTML += `<p class="mb-4">${info.description}</p>`;
                }
                
                // Display integrations list if available
                if (info.integrations && info.integrations.length > 0) {
                    contentHTML += `<p class="mb-2">${info.vendorName} offers integrations with:</p>`;
                    contentHTML += '<ul class="list-disc pl-5 space-y-1 mb-4">';
                    info.integrations.forEach(integration => {
                        contentHTML += `<li>${integration}</li>`;
                    });
                    contentHTML += '</ul>';
                }
                
                // Display integration documents if available
                if (info.integrationDocs && info.integrationDocs.length > 0) {
                    contentHTML += `<p class="mb-2">Documentation about ${info.vendorName} integrations:</p>`;
                    contentHTML += '<ul class="list-disc pl-5 space-y-1">';
                    info.integrationDocs.forEach(doc => {
                        const docName = doc.name || 'Integration Document';
                        contentHTML += `<li>${docName}</li>`;
                    });
                    contentHTML += '</ul>';
                    
                    contentHTML += `<p class="mt-3 text-sm text-gray-600">See detailed results below for more information.</p>`;
                }
                
                answerCard.innerHTML = contentHTML;
                directAnswer.appendChild(answerCard);
            }
            
            // Search the knowledge base for a keyword
            function searchKnowledgeBase(keyword) {
                const results = [];
                
                // Skip empty keywords
                if (!keyword || keyword.trim() === '') return results;
                
                // Search through each category in the knowledge base
                Object.entries(knowledgeBase || {}).forEach(([category, items]) => {
                    if (Array.isArray(items)) {
                        // For array-based categories (like vendors, technologies)
                        items.forEach(item => {
                            const itemString = JSON.stringify(item).toLowerCase();
                            if (itemString.includes(keyword)) {
                                results.push({item, category});
                            }
                        });
                    } else if (typeof items === 'object') {
                        // For object-based categories
                        const itemString = JSON.stringify(items).toLowerCase();
                        if (itemString.includes(keyword)) {
                            results.push({item: items, category});
                        }
                    }
                });
                
                return results;
            }

            // Display a search result
            function displayResult(item, category, searchTerm) {
                const resultCard = document.createElement('div');
                resultCard.className = 'bg-white p-5 rounded-lg shadow-md result-card';

                // Determine if this is a document type result
                const isDocument = category === 'documents' || item.type === 'docx' || item.type === 'pdf';
                
                // Create a title based on item properties
                let title = item.name || item.vendor || item.technology || item.service || category;
                
                // Build the content HTML
                let contentHTML = '';
                
                // For document-type results, show an icon
                if (isDocument) {
                    const fileType = item.type || getFileExtension(item.name || '') || 'default';
                    const iconClass = documentIcons[fileType] || documentIcons['default'];
                    
                    contentHTML = `
                        <div class="flex items-start">
                            <div class="document-icon">
                                <i class="${iconClass}"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-semibold text-blue-700 mb-2">${title}</h3>
                                <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mb-3">Category: ${formatKey(category)}</span>
                    `;
                    
                    // Add source file information if available
                    if (item.source_file) {
                        contentHTML += `<div class="text-sm text-gray-600 mb-3">Source: ${item.source_file}</div>`;
                    }
                    
                    contentHTML += `<div class="space-y-2">`;
                } else {
                    // Standard result format
                    contentHTML = `
                        <h3 class="text-xl font-semibold text-blue-700 mb-2">${title}</h3>
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mb-3">Category: ${formatKey(category)}</span>
                        <div class="space-y-2">
                    `;
                }
                
                // Process each property in the item
                Object.entries(item).forEach(([key, value]) => {
                    if (key !== 'name' && key !== 'vendor' && key !== 'technology' && key !== 'service' && key !== 'source_file') {
                        const valueStr = typeof value === 'object' ? JSON.stringify(value, null, 2) : value.toString();
                        const highlightedValue = highlightSearchTerm(valueStr, searchTerm.toLowerCase());
                        
                        contentHTML += `
                            <div class="property-row">
                                <div class="property-label">${formatKey(key)}:</div>
                                <div class="property-value">${formatValue(highlightedValue, key)}</div>
                            </div>
                        `;
                    }
                });
                
                contentHTML += `</div>`;
                
                // Close the document wrapper div if needed
                if (isDocument) {
                    contentHTML += `</div></div>`;
                }
                
                resultCard.innerHTML = contentHTML;
                searchResults.appendChild(resultCard);
            }
            
            // Format a value based on its key and content
            function formatValue(value, key) {
                // Format contact information
                if (key === 'contact' && value.includes('{')) {
                    try {
                        const contact = JSON.parse(value.replace(/'/g, '"'));
                        let formatted = '';
                        if (contact.primary) formatted += `<div>Primary: ${contact.primary}</div>`;
                        if (contact.email) formatted += `<div>Email: <a href="mailto:${contact.email}" class="text-blue-600 hover:underline">${contact.email}</a></div>`;
                        if (contact.accountId) formatted += `<div>Account ID: ${contact.accountId}</div>`;
                        return formatted || value;
                    } catch (e) {
                        return value;
                    }
                }
                
                // Format arrays
                if (value.startsWith('[') && value.endsWith(']')) {
                    try {
                        const array = JSON.parse(value);
                        return array.map(item => `<div>${item}</div>`).join('');
                    } catch (e) {
                        return value;
                    }
                }
                
                // Format objects
                if (value.startsWith('{') && value.endsWith('}')) {
                    try {
                        const obj = JSON.parse(value);
                        return Object.entries(obj).map(([k, v]) => {
                            return `<div><span class="font-medium">${formatKey(k)}:</span> ${v}</div>`;
                        }).join('');
                    } catch (e) {
                        return value;
                    }
                }
                
                return value;
            }

            // Format property keys for better display
            function formatKey(key) {
                return key.split(/[_\s]/).map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
            }

            // Get file extension from filename
            function getFileExtension(filename) {
                return filename.split('.').pop().toLowerCase();
            }

            // Highlight search term in result text
            function highlightSearchTerm(text, searchTerm) {
                if (!searchTerm) return text;
                
                // Extract keywords to highlight
                const keywords = extractKeywords(searchTerm);
                
                // Simple version for strings
                if (typeof text === 'string') {
                    let highlightedText = text;
                    keywords.forEach(keyword => {
                        if (keyword.length > 2) {  // Only highlight keywords longer than 2 chars
                            const regex = new RegExp('\\b' + keyword + '\\b', 'gi');
                            highlightedText = highlightedText.replace(regex, match => 
                                `<span class="highlight">${match}</span>`);
                        }
                    });
                    return highlightedText;
                }
                return text;
            }

            // Event listeners
            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // Auto-focus the search input
            searchInput.focus();
        });
    </script>
</body>
</html>
